//>>built
define("esri/layers/LabelLayer","require dojo/_base/declare dojo/_base/lang dojo/number dojo/i18n!dojo/cldr/nls/number dojo/_base/array dojo/_base/connect dojo/has dojox/gfx/_base ../kernel ../lang ../graphic ../PopupInfo ./labelLayerUtils/DynamicLabelClass ./labelLayerUtils/StaticLabelClass ../symbols/TextSymbol ../symbols/ShieldLabelSymbol ../geometry/Extent ../geometry/Point ../geometry/webMercatorUtils ./GraphicsLayer ./LabelClass ../renderers/SimpleRenderer".split(" "),function(p,z,m,A,u,v,n,
B,w,C,x,D,E,F,G,q,s,H,I,y,J,t,K){function L(a){return"sizeInfo"===a.type}p=z(J,{declaredClass:"esri.layers.LabelLayer",constructor:function(a){this.id="labels";this.featureLayers=[];this._featureLayerInfos=[];this._preparedLabels=[];this._engineType="STATIC";this._mapEventHandlers=[];a&&(a.id&&(this.id=a.id),a.mode&&(this._engineType="DYNAMIC"===a.mode.toUpperCase()?"DYNAMIC":"STATIC"))},_setMap:function(a){var d=this.inherited(arguments);this._map&&this._mapEventHandlers.push(this._map.on("extent-change",
m.hitch(this,"refresh")));this.refresh();return d},_unsetMap:function(){var a;for(a=0;a<this._mapEventHandlers.length;a++)n.disconnect(this._mapEventHandlers[a]);this.refresh();this.inherited(arguments)},setAlgorithmType:function(a){this._engineType=a&&"DYNAMIC"===a.toUpperCase()?"DYNAMIC":"STATIC";this.refresh()},addFeatureLayer:function(a,d,c,h){if(!this.getFeatureLayer(a.layerId)){var b=[];b.push(a.on("update-end",m.hitch(this,"refresh")));b.push(a.on("suspend",m.hitch(this,"refresh")));b.push(a.on("resume",
m.hitch(this,"refresh")));b.push(a.on("edits-complete",m.hitch(this,"refresh")));b.push(a.on("labeling-info-change",m.hitch(this,"refresh")));b.push(a.on("time-extent-change",m.hitch(this,"refresh")));b.push(a.on("show-labels-change",m.hitch(this,"refresh")));this._featureLayerInfos.push({FeatureLayer:a,LabelExpressionInfo:c,LabelingOptions:h,LabelRenderer:d,EventHandlers:b});this.featureLayers.push(a);this.refresh()}},getFeatureLayer:function(a){var d,c;for(d=0;d<this.featureLayers.length;d++)if(c=
this.featureLayers[d],void 0!==c&&c.id==a)return c;return null},removeFeatureLayer:function(a){var d;a=this.getFeatureLayer(a);if(void 0!==a&&(d=v.indexOf(this.featureLayers,a),-1<d)){this.featureLayers.splice(d,1);for(a=0;a<this._featureLayerInfos[d].EventHandlers.length;a++)n.disconnect(this._featureLayerInfos[d].EventHandlers[a]);this._featureLayerInfos.splice(d,1);this.refresh()}},removeAllFeatureLayers:function(){var a;for(a=0;a<this.featureLayers.length;a++){for(var d=0;d<this._featureLayerInfos[a].EventHandlers.length;d++)n.disconnect(this._featureLayerInfos[a].EventHandlers[d]);
this.featureLayers=[];this._featureLayerInfos=[]}this.refresh()},getFeatureLayers:function(){return this.featureLayers},getFeatureLayerInfo:function(a){var d,c;for(d=0;d<this.featureLayers.length;d++)if(c=this.featureLayers[d],void 0!==c&&c.id==a)return this._featureLayerInfos[d];return null},refresh:function(a){var d,c,h,b,g,e=[],f,k="DYNAMIC"===this._engineType?new F:new G;if(this._map){k.setMap(this._map,this);this._preparedLabels=[];for(a=0;a<this.featureLayers.length;a++)if(c=this.featureLayers[a],
c.visible&&c.showLabels&&c.visibleAtMapScale&&!c._suspended)if(d=this._featureLayerInfos[a],g=this._convertOptions(null),d.LabelRenderer){if(e=c.labelingInfo)if(f=e[0])b=this._getLabelExpression(f),g=this._convertOptions(f);h=d.LabelRenderer;d.LabelExpressionInfo&&(b=d.LabelExpressionInfo);d.LabelingOptions&&(g=this._convertOptions(null),void 0!==d.LabelingOptions.pointPriorities&&(e=d.LabelingOptions.pointPriorities,g.pointPriorities="above-center"==e||"AboveCenter"==e||"esriServerPointLabelPlacementAboveCenter"==
e?"AboveCenter":"above-left"==e||"AboveLeft"==e||"esriServerPointLabelPlacementAboveLeft"==e?"AboveLeft":"above-right"==e||"AboveRight"==e||"esriServerPointLabelPlacementAboveRight"==e?"AboveRight":"below-center"==e||"BelowCenter"==e||"esriServerPointLabelPlacementBelowCenter"==e?"BelowCenter":"below-left"==e||"BelowLeft"==e||"esriServerPointLabelPlacementBelowLeft"==e?"BelowLeft":"below-right"==e||"BelowRight"==e||"esriServerPointLabelPlacementBelowRight"==e?"BelowRight":"center-center"==e||"CenterCenter"==
e||"esriServerPointLabelPlacementCenterCenter"==e?"CenterCenter":"center-left"==e||"CenterLeft"==e||"esriServerPointLabelPlacementCenterLeft"==e?"CenterLeft":"center-right"==e||"CenterRight"==e||"esriServerPointLabelPlacementCenterRight"==e?"CenterRight":"AboveRight"),void 0!==d.LabelingOptions.lineLabelPlacement&&(g.lineLabelPlacement=d.LabelingOptions.lineLabelPlacement),void 0!==d.LabelingOptions.lineLabelPosition&&(g.lineLabelPosition=d.LabelingOptions.lineLabelPosition),void 0!==d.LabelingOptions.labelRotation&&
(g.labelRotation=d.LabelingOptions.labelRotation),void 0!==d.LabelingOptions.howManyLabels&&(g.howManyLabels=d.LabelingOptions.howManyLabels));h instanceof t&&(b=this._getLabelExpression(h),h=new K(h.symbol),g=this._convertOptions(h));this._addLabels(c,h,b,g)}else if(e=c.labelingInfo)for(d=e.length-1;0<=d;d--)if(f=e[d])h=new t(f instanceof t?f.toJson():f),b=this._getLabelExpression(f),g=this._convertOptions(f),this._addLabels(c,h,b,g);b=k._process(this._preparedLabels);this.clear();this.drawLabels(this._map,
b)}},drawLabels:function(a,d){this._scale=(a.extent.xmax-a.extent.xmin)/a.width;var c;for(c=0;c<d.length;c++){var h=d[c],b=h.x,g=h.y,e=h.text,f=h.angle,k=h.layer.labelSymbol;"polyline"==h.layer.geometry.type&&h.layer.options.labelRotation&&k.setAngle(f*(180/Math.PI));k.setText(e);h=b;k instanceof q&&(b=k.getHeight(),f=Math.sin(f),h-=0.25*b*this._scale*f,g-=0.33*b*this._scale);f=new D(new I(h,g,a.extent.spatialReference));f.setSymbol(k);this.add(f)}},_addLabels:function(a,d,c,h){var b,g,e,f;if(this._isWithinScaleRange(d.minScale,
d.maxScale)&&c&&""!==c){var k=this._map,l=!a.url&&!k.spatialReference.equals(a.spatialReference);for(b=0;b<a.graphics.length;b++)if(g=a.graphics[b],!1!==g.visible){e=g.geometry;if(l){if(!y.canProject(e,k))continue;e=y.project(e,k)}e&&(this._isWhere(d.where,g.attributes)&&this._isWithinScreenArea(e))&&(f=this._buildLabelText(c,g.attributes,a.fields,h),this._addLabel(f,d,a.renderer,g,h,e,k))}}},_isWithinScreenArea:function(a){a="point"===a.type?new H(a.x,a.y,a.x,a.y,a.spatialReference):a.getExtent();
if(void 0===a)return!1;a=this._intersects(this._map,a);return null===a||0===a.length?!1:!0},_isWithinScaleRange:function(a,d){var c=this._map.getScale();return 0<a&&c>=a||0<d&&c<=d?!1:!0},_isWhere:function(a,d){try{if(!a)return!0;if(a){var c=a.split(" ");if(3===c.length)return this._sqlEquation(d[c[0].substr(1,c[0].length-2)],c[1],c[2]);if(7===c.length){var h=this._sqlEquation(d[c[0].substr(1,c[0].length-2)],c[1],c[2]),b=c[3],g=this._sqlEquation(d[c[4].substr(1,c[4].length-2)],c[5],c[6]);switch(b){case "AND":return h&&
g;case "OR":return h||g}}}return!1}catch(e){}},_sqlEquation:function(a,d,c){switch(d){case "\x3d":return a==c?!0:!1;case "\x3c\x3e":return a!=c?!0:!1;case "\x3e":return a>c?!0:!1;case "\x3e\x3d":return a>=c?!0:!1;case "\x3c":return a<c?!0:!1;case "\x3c\x3d":return a<=c?!0:!1}return!1},_getSizeInfo:function(a){return a?a.sizeInfo||v.filter(a.visualVariables,L)[0]:null},_addLabel:function(a,d,c,h,b,g,e){var f,k,l,r;if(a&&""!==m.trim(a)&&d){a=a.replace(/\s+/g," ");f=d.getSymbol(h);f instanceof q?(f=
new q(f.toJson()),f.setVerticalAlignment("baseline"),f.setHorizontalAlignment("center")):f=f instanceof s?new s(f.toJson()):new q;f.setText(a);d.symbol=f;if(l=this._getProportionalSize(d.sizeInfo,h.attributes))f instanceof q?f.setSize(l):f instanceof s&&(f.setWidth(l),f.setHeight(l));r=l=0;if(c){k=c.getSymbol(h);var p=this._getSizeInfo(c),n;p&&(n=c.getSize(h,{sizeInfo:p,resolution:e.getResolutionInMeters()}));if(null!=n)l=r=n;else if(k)if("simplemarkersymbol"==k.type)r=l=k.size;else if("picturemarkersymbol"==
k.type)l=k.width,r=k.height;else if("simplelinesymbol"==k.type||"cartographiclinesymbol"==k.type)l=k.width}c={};c.graphic=h;c.options=b;c.geometry=g;c.labelRenderer=d;c.labelSymbol=f;c.labelWidth=f.getWidth()/2;c.labelHeight=f.getHeight()/2;c.symbolWidth=w.normalizedLength(l)/2;c.symbolHeight=w.normalizedLength(r)/2;c.text=a;c.angle=f.angle;this._preparedLabels.push(c)}},_buildLabelText:function(a,d,c,h){return a.replace(/{[^}]*}/g,function(a){var g,e=a;for(g=0;g<c.length;g++)if("{"+c[g].name+"}"==
a){var e=d[c[g].name],f=c[g].domain;if(f&&m.isObject(f)){if("codedValue"==f.type)for(a=0;a<f.codedValues.length;a++)f.codedValues[a].code==e&&(e=f.codedValues[a].name);else"range"==f.type&&(f.minValue<=e&&e<=f.maxValue)&&(e=f.name);break}f=c[g].type;if(h.fieldInfos){var k=h.fieldInfos;for(g=0;g<k.length;g++)if("{"+k[g].fieldName+"}"==a){a=k[g].format;if("esriFieldTypeDate"==f)(a="DateFormat"+E.prototype._dateFormats[a.dateFormat?a.dateFormat:"shortDate"])&&(e=x.substitute({myKey:e},"${myKey:"+a+"}"));
else if(("esriFieldTypeInteger"==f||"esriFieldTypeSingle"==f||"esriFieldTypeSmallInteger"==f||"esriFieldTypeLong"==f||"esriFieldTypeDouble"==f)&&a)e=A.format(e,{places:a.places}),a.digitSeparator||u.group&&(e=e.replace(RegExp("\\"+u.group,"g"),""));break}}break}else e="";return null===e?"":e})},_getLabelExpression:function(a){return a.labelExpressionInfo?a.labelExpressionInfo.value:this._validSyntax(a.labelExpression)?this._convertLabelExpression(a.labelExpression):""},_validSyntax:function(a){return/^(\s*\[[^\]]+\]\s*)+$/i.test(a)},
_convertLabelExpression:function(a){return a.replace(RegExp("\\[","g"),"{").replace(RegExp("\\]","g"),"}")},_getProportionalSize:function(a,d){if(!a)return null;var c=x.substitute(d,"${"+a.field+"}",{first:!0});return!a.minSize||!a.maxSize||!a.minDataValue||!a.maxDataValue||!c||0>=a.maxDataValue-a.minDataValue?null:(a.maxSize-a.minSize)/(a.maxDataValue-a.minDataValue)*(c-a.minDataValue)+a.minSize},_convertOptions:function(a){var d="shortDate",c=null,h=null,b="",g=!0;a&&(a.format&&(d=a.format.dateFormat,
c={places:a.format.places,digitSeparator:a.format.digitSeparator}),h=a.fieldInfos,b=a.labelPlacement);if("always-horizontal"==b||"esriServerPolygonPlacementAlwaysHorizontal"==b)g=!1;return{dateFormat:d,numberFormat:c,fieldInfos:h,pointPriorities:"above-center"==b||"esriServerPointLabelPlacementAboveCenter"==b?"AboveCenter":"above-left"==b||"esriServerPointLabelPlacementAboveLeft"==b?"AboveLeft":"above-right"==b||"esriServerPointLabelPlacementAboveRight"==b?"AboveRight":"below-center"==b||"esriServerPointLabelPlacementBelowCenter"==
b?"BelowCenter":"below-left"==b||"esriServerPointLabelPlacementBelowLeft"==b?"BelowLeft":"below-right"==b||"esriServerPointLabelPlacementBelowRight"==b?"BelowRight":"center-center"==b||"esriServerPointLabelPlacementCenterCenter"==b?"CenterCenter":"center-left"==b||"esriServerPointLabelPlacementCenterLeft"==b?"CenterLeft":"center-right"==b||"esriServerPointLabelPlacementCenterRight"==b?"CenterRight":"AboveRight",lineLabelPlacement:"above-start"==b||"below-start"==b||"center-start"==b?"PlaceAtStart":
"above-end"==b||"below-end"==b||"center-end"==b?"PlaceAtEnd":"PlaceAtCenter",lineLabelPosition:"above-after"==b||"esriServerLinePlacementAboveAfter"==b||"above-along"==b||"esriServerLinePlacementAboveAlong"==b||"above-before"==b||"esriServerLinePlacementAboveBefore"==b||"above-start"==b||"esriServerLinePlacementAboveStart"==b||"above-end"==b||"esriServerLinePlacementAboveEnd"==b?"Above":"below-after"==b||"esriServerLinePlacementBelowAfter"==b||"below-along"==b||"esriServerLinePlacementBelowAlong"==
b||"below-before"==b||"esriServerLinePlacementBelowBefore"==b||"below-start"==b||"esriServerLinePlacementBelowStart"==b||"below-end"==b||"esriServerLinePlacementBelowEnd"==b?"Below":"center-after"==b||"esriServerLinePlacementCenterAfter"==b||"center-along"==b||"esriServerLinePlacementCenterAlong"==b||"center-before"==b||"esriServerLinePlacementCenterBefore"==b||"center-start"==b||"esriServerLinePlacementCenterStart"==b||"center-end"==b||"esriServerLinePlacementCenterEnd"==b?"OnLine":"Above",labelRotation:g,
howManyLabels:"OneLabel"}}});B("extend-esri")&&m.setObject("layers.LabelLayer",p,C);return p});