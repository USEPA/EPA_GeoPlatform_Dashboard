//>>built
define("esri/layers/VectorTileLayer","require dojo/_base/declare dojo/_base/lang dojo/_base/url dojo/dom-construct dojo/dom-style dojo/has dojo/Deferred ../lang ../domUtils ../urlUtils ../kernel ../config ../request ../SpatialReference ../geometry/Extent ./layer ./TileInfo ./unitBezier".split(" "),function(P,B,m,Q,F,R,q,t,G,H,l,r,C,D,I,u,n,J,S){var E=B(n,{declaredClass:"esri.layers.VectorTileLayer",_mapsWithAttribution:["World_Basemap"],_eventMap:{"style-change":["style"]},constructor:function(a,
b){this._displayLevels=b?b.displayLevels:null;this._serviceOverrides={};b&&(b.tileServers&&b.tileServers.length)&&(this._serviceOverrides.tileServers=b.tileServers.map(function(a){return g.isMapboxUrl(a)?a:l.getAbsoluteUrl(l.urlToObject(a).path)},this));if("string"===typeof a){var c=g.isMapboxUrl(a),d=c?a:l.getAbsoluteUrl(a);if(!c&&(c=/token=([^&]+)/i.exec(d)))d=l.urlToObject(a).path,this._serviceOverrides.credential={url:d,token:c[1]};urlOrObbject=d}this.setStyle(a);this.registerConnectEvents()},
setStyle:function(a){if(a)return this._loadStyle(a)},opacity:1,setOpacity:function(a){if(this.opacity!=a)this.onOpacityChange(this.opacity=a)},onOpacityChange:function(){},refresh:function(){},_loadStyle:function(a){return(new t).resolve().then(function(){var a=new t;null==q("ie")||9<q("ie")?h?h.supported()?a.resolve():a.reject(Error("layer not supported"),!0):P(["./vector-tile"],function(c){h=c;h.supported()?a.resolve():a.reject(Error("layer not supported"),!0)}):a.reject(Error("layer not supported"),
!0);return a.promise}).then(function(){h.tokenHandler?v=h.tokenHandler:(v=new T,h.tokenHandler=v);this._serviceOverrides&&this._serviceOverrides.credential&&v.addToken(this._serviceOverrides.credential);return g.loadMetadata(a,this._serviceOverrides)}.bind(this)).then(m.hitch(this,function(b){var c=b.layerDefinition;this.serviceUrl=b.serviceUrl||null;this.styleUrl=b.styleUrl||null;c?(this.spatialReference=c.initialExtent&&c.initialExtent.spatialReference&&new I(c.initialExtent.spatialReference),this.initialExtent=
c.initialExtent&&new u(c.initialExtent),this.fullExtent=c.fullExtent&&new u(c.fullExtent),this.version=c.currentVersion,this.tileInfo=new J(c.tileInfo),G.isDefined(c.minScale)&&!this._hasMin&&this.setMinScale(c.minScale),G.isDefined(c.maxScale)&&!this._hasMax&&this.setMaxScale(c.maxScale),c=null,a&&(c=l.urlToObject(b.serviceUrl).path.toLowerCase(),c=this._getDefaultAttribution(this._getMapName(c))),c&&(this.attributionDataUrl=c,this.hasAttributionData=!0)):(this.spatialReference=w,this.initialExtent=
K,this.fullExtent=L,this.tileInfo=M,this.version=null);for(var c=this.tileInfo.lods,d=this.scales=[],e=this._displayLevels,f=-Infinity,s=Infinity,k,g=0,m=c.length;g<m;g++)if(k=c[g],!e||-1!==e.indexOf(k.level))d[g]=k.scale,f=k.scale>f?k.scale:f,s=k.scale<s?k.scale:s;-Infinity!==f&&!this._hasMin&&this.setMinScale(f);Infinity!==s&&!this._hasMax&&this.setMaxScale(s);this.style=b.style;this.gl&&(h.identityManager=r.id,this._applyGLStyle(this.style));this.onStyleChange(this.style)})).then(m.hitch(this,
function(){!this.loaded&&!this.loadError&&(this.loaded=!0,this.onLoad(this))})).otherwise(m.hitch(this,function(a){this._errorHandler(a);throw a;}))},_setMap:function(a,b,c){this.inherited(arguments);this._map=a;var d=this._div=F.create("div",null,b);R.set(d,{position:"absolute",width:a.width+"px",height:a.height+"px",overflow:"visible",opacity:this.opacity});this._onResizeHandle=a.on("resize",m.hitch(this,this._onResizeHandler));this._onOpacityHandle=this.on("opacity-change",m.hitch(this,this._opacityChangeHandler));
h.identityManager=r.id;this.gl=new h.Renderer({container:d});this.gl.setSize(a.width,a.height);this._applyGLStyle(this.style);this.evaluateSuspension();if(this.suspended&&!a.loaded)var e=a.on("load",m.hitch(this,function(){e.remove();this.evaluateSuspension()}));return d},_unsetMap:function(a,b){this.gl.remove();this.gl=null;F.destroy(this._div);this._map=this._div=null;this._onResizeHandle=this._onResizeHandle&&this._onResizeHandle.remove()&&null;this._onOpacityHandle=this._onOpacityHandle&&this._onOpacityHandle.remove()&&
null;this._disableDrawConnectors();this._animation&&(this._animation.stop(),this._animation=null);this.inherited(arguments)},_applyGLStyle:function(a){var b=this.gl;b&&(a?(a.animationLoop=b.animationLoop,b.setStyle(a),a._loaded&&(Object.getOwnPropertyNames(a.sources).forEach(function(a){this.fire("source.add",{source:this.sources[a]})},a),a.fire("load"),a.sprite.loaded()&&a.fire("change"))):b.setStyle(null))},_enableDrawConnectors:function(){var a=this._map;a&&(this._panHandle=a.on("pan",m.hitch(this,
this._onPanExtentChangeHandler)),this._extentChangeHandle=a.on("extent-change",m.hitch(this,this._onPanExtentChangeHandler)),this._onScaleHandle=a.on("scale",m.hitch(this,this._onScaleHandler)))},_disableDrawConnectors:function(){this._onScaleHandle=this._onScaleHandle&&this._onScaleHandle.remove()&&null;this._panHandle=this._panHandle&&this._panHandle.remove()&&null;this._extentChangeHandle=this._extentChangeHandle&&this._extentChangeHandle.remove()&&null},_getZoom:function(a,b){var c=this.tileInfo.lods,
d=null,e=null;b=0;var f=c.length-1;for(b;b<f;b++){d=c[b];e=c[b+1];if(d.scale<=a)return b;if(e.scale===a)return b+1;if(d.scale>a&&e.scale<a){b=b+1-(a-e.scale)/(d.scale-e.scale);b=Math.ceil(b)-Math.log(Math.abs(Math.ceil(b)-b+1))/Math.LN2;if(0.995<b-Math.floor(b)||0.005>b-Math.floor(b))b=Math.round(b);return b}}return a>c[0].scale?c[0].level:c[c.length-1].level},_isMapAtVisibleScale:function(){var a=this.inherited(arguments);if(a){for(var b=this._map,a=this.scales,c=b.getScale(),d=!1,b=b.width>b.height?
b.width:b.height,e=0,f=a.length;e<f;e++)if(Math.abs(a[e]-c)/a[e]<1/b){d=!0;break}a=d}return a},_getMapName:function(a){return(a=a.match(/^https?\:\/\/(basemaps|basemapsbeta)\.arcgis\.com\/arcgis\/rest\/services\/([^\/]+(\/[^\/]+)*)\/vectortileserver/i))&&a[2]},_getDefaultAttribution:function(a){if(a){var b;a=a.toLowerCase();for(var c=0,d=this._mapsWithAttribution.length;c<d;c++)if(b=this._mapsWithAttribution[c],-1<b.toLowerCase().indexOf(a))return"file:"===window.location.protocol?"http:":window.location.protocol+
"//static.arcgis.com/attribution/Vector/"+b}},onStyleChange:function(a){},_opacityChangeHandler:function(a){this.gl&&(this._div.style.opacity=a.opacity)},_onResizeHandler:function(a){if(this.gl){var b=a.extent.getCenter();this.gl.setSize(a.width,a.height);this.gl.jumpTo({center:[b.getLongitude(),b.getLatitude()]});this._div.style.width=a.width+"px";this._div.style.height=a.height+"px"}},onSuspend:function(){this.inherited(arguments);H.hide(this._div);this._disableDrawConnectors()},onResume:function(){this.inherited(arguments);
if(this.gl&&this.style){H.show(this._div);var a=this._map,b=this._getZoom(a.getScale()),a=a.extent.getCenter();this._animate(a,b,!0)}this._enableDrawConnectors()},_onPanExtentChangeHandler:function(a){var b=this._getZoom(this._map.getScale());a=a.extent.getCenter();this._animate(a,b,!0)},_onScaleHandler:function(a){var b=this._map,c=b._zoomAnimDiv.anchor,d=b._zoomAnimDiv.extent.getCenter(),b=this._getZoom(b._zoomAnimDiv.newLod.scale,b._zoomAnimDiv.newLod.level);this._animate(d,b,a.immediate,c)},_animate:function(a,
b,c,d){this._animation&&(this._animation.stop(),this._animation=null);this._animation=U(this.gl,a.getLongitude(),a.getLatitude(),b,c,this._map,d)}}),h=null,v=null;n=Object.freeze||function(a){};for(var x=[],p=0;20>p;p++){var y=78271.51696402048/Math.pow(2,p);x.push({level:p,scale:Math.floor(3779.527559055118*y),resolution:y})}var M=new J({rows:512,cols:512,dpi:96,format:"pbf",origin:{x:-2.0037508342787E7,y:2.0037508342787E7},spatialReference:{wkid:102100},lods:x});n(M);var w=new I(102100);n(w);var K=
new u(-2.003750834E7,-2.003750834E7,2.003750834E7,2.003750834E7,w);n(K);var L=new u(-2.003750834E7,-2.003750834E7,2.003750834E7,2.003750834E7,w);n(L);var z=function(){var a,b=window.performance||{},c=b.now||b.webkitNow||b.msNow||b.oNow||b.mozNow;if(void 0!==c)return function(){return c.call(b)};a=window.performance&&window.performance.timing&&window.performance.timing.navigationStart?window.performance.timing.navigationStart:(new Date).getTime();return function(){return(new Date).getTime()-a}}();
n=q("ff");var x=q("ie"),p=q("webkit"),y=q("opera"),N=(new Date).getTime(),A=window.requestAnimationFrame;A||(A=window[(p&&"webkit"||n&&"moz"||y&&"o"||x&&"ms")+"RequestAnimationFrame"])||(A=function(a){var b=z(),c=Math.max(0,16-(b-N)),d=window.setTimeout(function(){a(z())},c);N=b+c;return d});var V=S.ease,U=function(a,b,c,d,e,f,g){if(e=e||0===C.defaults.map.zoomDuration)return a.jumpTo({center:[b,c],zoom:Math.ceil(d)-Math.log(Math.abs(Math.ceil(d)-d+1))/Math.LN2}),null;var k=!0,m=C.defaults.map.zoomDuration,
h=a.transform.center.lat,l=a.transform.center.lng,n=a.transform.zoom,q=z()+16,p=g?[g.x-f.width/2,g.y-f.height/2]:null,r=function(){if(k){var e=(z()+16-q)/m;1<=e&&(e=1,k=!1);var e=V(e),f=n+(d-n)*e,f=Math.ceil(f)-Math.log(Math.abs(Math.ceil(f)-f+1))/Math.LN2;p?a.zoomTo(f,{animate:!1,offset:p}):a.jumpTo({center:[l+(b-l)*e,h+(c-h)*e],zoom:f});k&&A(r)}};r();return{stop:function(){k=!1}}},O=B(String,{constructor:function(a,b){this.value=a;this.token=b},valueOf:function(){var a=this.value,b=this.token;if(!b){var c=
r.id&&r.id.findCredential(a);c&&c.token&&(b=c.token)}b&&(a+=(-1===a.indexOf("?")?"?":"\x26")+"token\x3d"+b);return a},toString:function(){return this.valueOf()},replace:function(a,b){return String.prototype.replace.call(this.valueOf(),a,b)}}),g={loadMetadata:function(a,b){var c=null,d=null,e=b&&b.credential;return(new t).resolve(a).then(function(){h.config.ACCESS_TOKEN=E.ACCESS_TOKEN;if("string"!==typeof a)return a;g.isMapboxUrl(a)?(d=a,c=h.normalizeStyleURL(a)):d=c=l.normalize(a).replace(/\/*$/,
"");g._corsify(c);c=g._appendToken(c,e);return D({url:c,content:{f:"json"},handleAs:"json"})}).then(function(a){return g._processMetadata(d,a,b)}).then(function(a){return g._loadStyle(a,b)})},isMapboxUrl:function(a){return-1<a.search(/^mapbox:\/\/styles\//)},_appendToken:function(a,b){return!b||!b.token?a:a+=(-1===a.indexOf("?")?"?":"\x26")+"token\x3d"+b.token},_configureStyle:function(a,b){var c=a.layerDefinition,d=a.style,e=a.serviceUrl,f=a.styleUrl,h=g._getAbsolutePath,k=g._corsify;if(c&&d&&d.sources.esri){var m=
c.tilejson||"2.0.0",l=c.tileInfo&&c.tileInfo.format||"pbf",n=c.tileMap?k(h(c.tileMap,e)):null,p=(c.tiles||[]).map(function(a){return new O(g._getAbsolutePath(a,e),b&&b.credential&&b.credential.token)});d.sources.esri={type:"vector",scheme:"xyz",tilejson:m,format:l,index:n,tiles:p,description:c.description,name:c.name};p.forEach(k);d.glyphs=k(h(d.glyphs,f));d.sprite=k(h(d.sprite,f))}return{style:d,layerDefinition:c,serviceUrl:e,styleUrl:f}},_loadStyle:function(a,b){var c=new t,d=a.style,e=d.sources;
b&&b.tileServers&&Object.getOwnPropertyNames(e).forEach(m.hitch(this,function(c){c=e[c];var d=b.tileServers.map(function(c){return new O(g._getAbsolutePath(c,a.serviceUrl,b))});c.tiles=d;d.forEach(g._corsify)}));h.identityManager=r.id;var d=new h.Style(d),f=function(){d.off("load",f);d.off("error",l);a.style=d;c.resolve(a)},l=function(a){d.off("load",f);d.off("error",l);c.reject(a)};d.on("load",f);d.on("error",l);return c.promise},_getAbsolutePath:function(a,b){var c;b=l.urlToObject(b||"").path;if(/^https?:\/\//i.test(a))c=
a;else{if(0===a.indexOf("//"))return location.protocol+a;b=b.replace(/(\/+\w+\.\w+)$/,"");/\/+$/.test(b)||(b+="/");0===a.indexOf("/")&&(a=a.substring(1));c=b+a}return l.normalize(c)},_corsify:function(a){a=a.valueOf();var b=C.defaults.io.corsEnabledServers;if(!l.canUseXhr(a)){var c=new Q(a),c=(c.host+(c.port?":"+c.port:"")).toLowerCase();-1===b.indexOf(c)&&b.push(c)}return a},_processMetadata:function(a,b,c){var d={},e,f,h=g._getAbsolutePath,k=g._configureStyle,l=g._corsify,n=c&&c.credential;delete b._ssl;
if(b.currentVersion)return e=a,f=h(b.defaultStyles,e),D({url:g._appendToken(f,n),content:{f:"json"},handleAs:"json"}).then(m.hitch(this,function(a){return k({style:a,layerDefinition:b,styleUrl:f,serviceUrl:e},c)}));d=b;f=a;return b.sources.esri&&b.sources.esri.url?(e=l(h(b.sources.esri.url,f)),D({url:g._appendToken(e,n),content:{f:"json"},handleAs:"json"}).then(m.hitch(this,function(a){return k({style:d,layerDefinition:a,styleUrl:f,serviceUrl:e},c)}))):k({style:d})}},T=B([],{constructor:function(){this._credentials=
[]},addToken:function(a){if(!a||!a.url||!a.token)return!1;var b=this.getServiceRoot(a.url);this._credentials.push({rootUrl:b,token:a.token})},findCredential:function(a){var b=-1,c=this._credentials,d=this.getServiceRoot(a);c.some(function(a,c){if(a.rootUrl===d)return b=c,!0});return-1<b?c[b]:null},getServiceRoot:function(a){var b=/(.+\/rest\/services\/.*\/?vectortileserver)/i,c=/(.+\/sharing\/.*)/i;return b.test(a)?a.match(b)[1].toLowerCase():c.test(a)?a.match(c)[1].toLowerCase():null},shareSameService:function(a,
b){a=this.getServiceRoot(a);b=this.getServiceRoot(b);a=a.substr(a.indexOf(":"));b=b.substr(b.indexOf(":"));return a===b}});E.ACCESS_TOKEN=null;return E});